<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ãƒšãƒƒãƒˆåŒä¼´OKã®å®¿ã‚’ãƒãƒƒãƒ—è¡¨ç¤º</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; display: flex; }
    h2 { padding: 1em; margin: 0; }
    #sidebar { 
      width: 300px; 
      background: #f5f5f5; 
      padding: 20px; 
      box-sizing: border-box;
      height: 100vh;
      overflow-y: auto;
    }
    #map { height: 100vh; flex: 1; }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    .form-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    #searchBtn {
      width: 100%;
      padding: 12px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    #searchBtn:hover {
      background: #1565c0;
    }
    .title {
      font-size: 18px;
      margin-bottom: 20px;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <div class="title">ğŸ¾ ãƒšãƒƒãƒˆåŒä¼´OKå®¿æ¤œç´¢</div>
    
    <div class="form-group">
      <label for="checkinDate">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ—¥</label>
      <input type="date" id="checkinDate" value="2025-08-10">
    </div>
    
    <div class="form-group">
      <label for="checkoutDate">ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ—¥</label>
      <input type="date" id="checkoutDate" value="2025-08-11">
    </div>
    
    <div class="form-group">
      <label for="adultNum">å¤§äººã®äººæ•°</label>
      <select id="adultNum" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <option value="1">1å</option>
        <option value="2" selected>2å</option>
        <option value="3">3å</option>
        <option value="4">4å</option>
        <option value="5">5å</option>
        <option value="6">6å</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="priceRange">ä¾¡æ ¼å¸¯ï¼ˆ1æ³Šã‚ãŸã‚Šï¼‰</label>
      <select id="priceRange" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <option value="">ã™ã¹ã¦ã®ä¾¡æ ¼å¸¯</option>
        <option value="0-5000">ï½5,000å††</option>
        <option value="5000-10000">5,000å††ï½10,000å††</option>
        <option value="10000-15000">10,000å††ï½15,000å††</option>
        <option value="15000-20000">15,000å††ï½20,000å††</option>
        <option value="20000-30000">20,000å††ï½30,000å††</option>
        <option value="30000-">30,000å††ï½</option>
      </select>
    </div>
    
    <button id="searchBtn" onclick="searchHotels()">æ¤œç´¢</button>
  </div>
  
  <div id="map"></div>

  <script>
    const rakutenAppId = '1045565995948230424';
    const googleMapApiKey = 'AIzaSyDGUJ80YBBxM1uiBY-wSdp1Ng_iQl90MKE'; // å…¬é–‹æ³¨æ„

    function buildRakutenUrl() {
      const checkinDate = document.getElementById('checkinDate').value;
      const checkoutDate = document.getElementById('checkoutDate').value;
      const adultNum = document.getElementById('adultNum').value;
      
      return `https://app.rakuten.co.jp/services/api/Travel/KeywordHotelSearch/20170426?format=jsonp&keyword=%E3%83%9A%E3%83%83%E3%83%88ok&applicationId=${rakutenAppId}&hits=30&checkinDate=${checkinDate}&checkoutDate=${checkoutDate}&adultNum=${adultNum}`;
    }

    let map;

    // æ¥½å¤©APIã®ç§’å˜ä½åº§æ¨™ã‚’åº¦ã«å¤‰æ›ã™ã‚‹é–¢æ•°
    function convertRakutenCoordinates(lat, lng) {
      // æ¥½å¤©APIã¯ç§’å˜ä½ã§åº§æ¨™ã‚’è¿”ã™ï¼ˆ1åº¦ = 3600ç§’ï¼‰
      const latDegrees = lat / 3600;
      const lngDegrees = lng / 3600;
      
      return {
        lat: latDegrees,
        lng: lngDegrees
      };
    }

    // ä¾¡æ ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°é–¢æ•°
    function filterByPrice(hotels) {
      const priceRange = document.getElementById('priceRange').value;
      if (!priceRange) return hotels;
      
      const [minPrice, maxPrice] = priceRange.split('-').map(p => p ? parseInt(p) : null);
      
      return hotels.filter(hotel => {
        if (!hotel.minCharge) return true; // ä¾¡æ ¼æƒ…å ±ãŒãªã„å ´åˆã¯è¡¨ç¤º
        
        const price = parseInt(hotel.minCharge);
        if (isNaN(price)) return true;
        
        if (minPrice && maxPrice) {
          return price >= minPrice && price <= maxPrice;
        } else if (minPrice) {
          return price >= minPrice;
        } else if (maxPrice) {
          return price <= maxPrice;
        }
        return true;
      });
    }

    function searchHotels() {
      // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
      if (map) {
        // ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ 
        console.log("æ¤œç´¢ã‚’å®Ÿè¡Œã—ã¾ã™...");
        initMap();
      }
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 35.681236, lng: 139.767125 },
        zoom: 12
      });

      // JSONPã‚’ä½¿ç”¨ã—ã¦CORSå•é¡Œã‚’å›é¿
      const script = document.createElement('script');
      const callbackName = 'rakutenCallback';
      
      window[callbackName] = function(data) {
        console.log("æ¥½å¤©APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:", data);
        console.log("ãƒ‡ãƒ¼ã‚¿æ§‹é€ ç¢ºèª:", typeof data, Object.keys(data));
        
        if (!data || (!data.hotels && !data.Items)) {
          console.log("ãƒ›ãƒ†ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", data);
          alert("ãƒšãƒƒãƒˆåŒä¼´OKã®å®¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
          return;
        }
        
        // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç¢ºèªï¼ˆæ¥½å¤©APIã¯æ™‚ã€…ç•°ãªã‚‹æ§‹é€ ã‚’è¿”ã™ï¼‰
        const hotels = data.hotels || data.Items;
        if (!hotels || hotels.length === 0) {
          console.log("ãƒ›ãƒ†ãƒ«é…åˆ—ãŒç©ºã§ã™:", hotels);
          alert("ãƒšãƒƒãƒˆåŒä¼´OKã®å®¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
          return;
        }
        
        console.log("å–å¾—ã—ãŸãƒ›ãƒ†ãƒ«æ•°:", hotels.length);

        // ãƒ›ãƒ†ãƒ«æƒ…å ±ã‚’é…åˆ—ã«æ•´ç†
        const hotelList = hotels.map((entry, index) => {
          console.log(`ãƒ›ãƒ†ãƒ«${index + 1}ã®æ§‹é€ :`, entry);
          
          // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç¢ºèªã—ã¦é©åˆ‡ã«ã‚¢ã‚¯ã‚»ã‚¹
          const info = entry.hotel ? entry.hotel[0].hotelBasicInfo : entry;
          console.log(`ãƒ›ãƒ†ãƒ«${index + 1}ã®åŸºæœ¬æƒ…å ±:`, info);
          
          if (!info) {
            console.log(`ãƒ›ãƒ†ãƒ«${index + 1}: åŸºæœ¬æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
            return null;
          }
          
          let lat = parseFloat(info.latitude);
          let lng = parseFloat(info.longitude);
          
          console.log(`ãƒ›ãƒ†ãƒ«${index + 1}ã®åº§æ¨™: lat=${lat}, lng=${lng}`);

          if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
            console.log(`ãƒ›ãƒ†ãƒ«${index + 1}: åº§æ¨™ãŒç„¡åŠ¹ã§ã™`);
            return null;
          }

          // æ¥½å¤©åº§æ¨™ã‚’æ­£è¦åŒ–
          const convertedCoords = convertRakutenCoordinates(lat, lng);
          console.log(`ãƒ›ãƒ†ãƒ«${index + 1}ã®å¤‰æ›å¾Œåº§æ¨™: lat=${convertedCoords.lat}, lng=${convertedCoords.lng}`);
          
          // å¤‰æ›å¾Œã®åº§æ¨™ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
          if (isNaN(convertedCoords.lat) || isNaN(convertedCoords.lng) || convertedCoords.lat < -90 || convertedCoords.lat > 90 || convertedCoords.lng < -180 || convertedCoords.lng > 180) {
            console.log(`ãƒ›ãƒ†ãƒ«${index + 1}: å¤‰æ›å¾Œã®åº§æ¨™ãŒç„¡åŠ¹ã§ã™`);
            return null;
          }
          
          return {
            name: info.hotelName,
            lat: convertedCoords.lat,
            lng: convertedCoords.lng,
            url: info.hotelInformationUrl,
            imageUrl: info.hotelImageUrl || info.hotelThumbnailUrl,
            petInfo: info.hotelSpecial || '',
            area: info.hotelArea || '',
            minCharge: info.hotelMinCharge || ''
          };
        }).filter(hotel => hotel !== null);
        
        console.log("å‡¦ç†ã•ã‚ŒãŸãƒ›ãƒ†ãƒ«æ•°:", hotelList.length);

        // ä¾¡æ ¼ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
        const filteredHotelList = filterByPrice(hotelList);
        console.log(`ä¾¡æ ¼ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨å¾Œã®ãƒ›ãƒ†ãƒ«æ•°: ${filteredHotelList.length}`);

        // ã™ã¹ã¦ã®ãƒ›ãƒ†ãƒ«ã‚’è¡¨ç¤ºï¼ˆåˆ¶é™ãªã—ï¼‰
        const limitedHotelList = filteredHotelList;
        console.log(`è¡¨ç¤ºã™ã‚‹ãƒ›ãƒ†ãƒ«æ•°: ${limitedHotelList.length}`);

        // ãƒãƒƒãƒ—ã®å¢ƒç•Œã‚’è¨ˆç®—ã—ã¦ã™ã¹ã¦ã®ãƒ›ãƒ†ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«èª¿æ•´
        if (limitedHotelList.length > 0) {
          const bounds = new google.maps.LatLngBounds();
          
          limitedHotelList.forEach(hotel => {
            bounds.extend(new google.maps.LatLng(hotel.lat, hotel.lng));
          });
          
          // å¢ƒç•Œã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¿½åŠ ã—ã¦ãƒãƒƒãƒ—ã‚’ãƒ•ã‚£ãƒƒãƒˆ
          map.fitBounds(bounds, {
            padding: { top: 50, right: 50, bottom: 50, left: 50 }
          });
          
          // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ãŒé«˜ããªã‚Šã™ããªã„ã‚ˆã†ã«åˆ¶é™
          const maxZoom = 10;
          google.maps.event.addListenerOnce(map, 'bounds_changed', function() {
            if (map.getZoom() > maxZoom) {
              map.setZoom(maxZoom);
            }
          });
        }

        // æ•´ç†ã•ã‚ŒãŸãƒ›ãƒ†ãƒ«é…åˆ—ã‹ã‚‰ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
        limitedHotelList.forEach(hotel => {
          const marker = new google.maps.Marker({
            position: { lat: hotel.lat, lng: hotel.lng },
            map: map,
            title: hotel.name,
            icon: {
              url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 36 36">
                  <circle cx="18" cy="18" r="17" fill="#FF6B6B" stroke="#D63384" stroke-width="2"/>
                  <g fill="#FFFFFF">
                    <ellipse cx="12" cy="12" rx="3" ry="4" transform="rotate(-30 12 12)"/>
                    <ellipse cx="24" cy="12" rx="3" ry="4" transform="rotate(30 24 12)"/>
                    <ellipse cx="18" cy="16" rx="6" ry="5"/>
                    <ellipse cx="18" cy="22" rx="4" ry="6"/>
                    <ellipse cx="18" cy="28" rx="2" ry="3"/>
                  </g>
                  <g fill="#333">
                    <circle cx="15" cy="17" r="1.5"/>
                    <circle cx="21" cy="17" r="1.5"/>
                    <ellipse cx="18" cy="20" rx="1" ry="1.5"/>
                  </g>
                </svg>
              `),
              scaledSize: new google.maps.Size(36, 36),
              anchor: new google.maps.Point(18, 36)
            }
          });

          const infoWindow = new google.maps.InfoWindow({
            content: `
              <div style="min-width:250px; max-width:300px; padding:5px;">
                ${hotel.imageUrl ? `<img src="${hotel.imageUrl}" alt="${hotel.name}" style="width:100%; height:120px; object-fit:cover; border-radius:4px; margin-bottom:8px; display:block;">` : ''}
                <strong style="font-size:14px; display:block; margin-bottom:5px;">${hotel.name}</strong>
                <div style="background:#e8f5e8; padding:4px 8px; border-radius:4px; margin-bottom:5px; font-size:12px;">
                  ğŸ• ãƒšãƒƒãƒˆåŒä¼´OK
                </div>
                ${hotel.area ? `<div style="font-size:12px; color:#666; margin-bottom:3px;">ğŸ“ ${hotel.area}</div>` : ''}
                ${hotel.minCharge ? `<div style="font-size:12px; color:#666; margin-bottom:5px;">ğŸ’° ${hotel.minCharge}å††ï½</div>` : ''}
                ${hotel.petInfo ? `<div style="font-size:11px; color:#555; margin-bottom:5px; background:#f0f0f0; padding:3px 6px; border-radius:3px;">${hotel.petInfo}</div>` : ''}
                <a href="${hotel.url}" target="_blank" style="color:#1976d2; text-decoration:none; font-size:13px;">è©³ç´°ã‚’è¦‹ã‚‹ â†’</a>
              </div>`
          });

          marker.addListener("click", () => infoWindow.open(map, marker));
        });
        
        // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’å‰Šé™¤
        document.head.removeChild(script);
        delete window[callbackName];
      };
      
      script.src = buildRakutenUrl() + '&callback=' + callbackName;
      script.onerror = function() {
        console.error("æ¥½å¤©APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼");
        alert("æ¥½å¤©APIã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¢ãƒ—ãƒªIDã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      };
      
      document.head.appendChild(script);
    }

    // Google Maps APIãŒèª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«initMapã‚’å®Ÿè¡Œ
    window.onload = function() {
      if (typeof google !== 'undefined') {
        initMap();
      }
    };
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDGUJ80YBBxM1uiBY-wSdp1Ng_iQl90MKE">
  </script>
</body>
</html>